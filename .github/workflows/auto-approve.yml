name: Auto-approve PRs with Identical Images

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  auto_approve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Identify Integration PR SHA
        run: |
          if [[ "${{ github.event.pull_request.base.ref }}" == "staging" ]]; then
            # Get SHA of current PR head
            current_pr_sha=${{ github.sha }}
            echo "Current PR SHA: $current_pr_sha"

            # Find approved integration PR with identical commits
            integration_pr_sha=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?state=closed&is:merged&base=integration" \
              | jq -r '.[] | select(.head.sha != "$current_pr_sha" and .maintainer_can_merge and .mergeable and .head.sha == any(.commits[].sha) as $sha | $sha)')

            echo "Integration PR SHA: $integration_pr_sha"

            if [[ "$integration_pr_sha" != "" ]]; then
              # Auto-approve current PR if integration PR with same image is approved
              curl -X PUT -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/reviews" \
                -d '{"event": "APPROVE"}'
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}